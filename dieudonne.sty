\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{dieudonne}[2020/10/08 Dieudonne]

\DeclareOption{memoir}{
  %% A patch to fix some problems with whitespace when an environment abuts a section heading.
  \patchcmd{\@xsect}{
    \vskip\@tempskipa\vskip-\parskip}{\addvspace{\@tempskipa}\addvspace{-\parskip}
  }{}{\typeout{WARNING! Patching \noexpand\@xsect failed!}}
}

\ProcessOptions\relax


\RequirePackage{xparse}
\RequirePackage{chngcntr}
\RequirePackage{amsmath}
\RequirePackage{etoolbox}
\RequirePackage{microtype}


\ExplSyntaxOn

%% Customizable

\newlength\DieudonneNodeIndent
\setlength\DieudonneNodeIndent{\parindent}

\NewDocumentCommand\DieudonneInterpunct{}{
  \textperiodcentered
}

\NewDocumentCommand\DieudonneFormatTrail{m}{
  #1
}



\newcounter{node}

\cs_new:Npn \dieudonne_if_counter_exist:nT #1 #2 {
  \cs_if_exist:cTF {c@#1} {#2} {}
}

% To set the counter resets safely in case Dieudonne is used in a class
% where these don't exist.
\cs_new:Npn \dieudonne_counter_within:nn #1 #2 {
  \dieudonne_if_counter_exist:nT {#1} {
    \dieudonne_if_counter_exist:nT {#2} {
      \counterwithin*{#1}{#2}
    }
  }
}

% all counters should be reset when an ancestor is stepped

\dieudonne_counter_within:nn{node}{chapter}
\dieudonne_counter_within:nn{node}{section}
\dieudonne_counter_within:nn{node}{subsection}
\dieudonne_counter_within:nn{node}{subsubsection}
\dieudonne_counter_within:nn{node}{paragraph}
\dieudonne_counter_within:nn{node}{subparagraph}

\dieudonne_counter_within:nn{subparagraph}{chapter}
\dieudonne_counter_within:nn{subparagraph}{section}
\dieudonne_counter_within:nn{subparagraph}{subsection}
\dieudonne_counter_within:nn{subparagraph}{subsubsection}
\dieudonne_counter_within:nn{subparagraph}{paragraph}

\dieudonne_counter_within:nn{paragraph}{chapter}
\dieudonne_counter_within:nn{paragraph}{section}
\dieudonne_counter_within:nn{paragraph}{subsection}
\dieudonne_counter_within:nn{paragraph}{subsubsection}

\dieudonne_counter_within:nn{subsubsection}{chapter}
\dieudonne_counter_within:nn{subsubsection}{section}
\dieudonne_counter_within:nn{subsubsection}{subsection}

\dieudonne_counter_within:nn{subsection}{chapter}
\dieudonne_counter_within:nn{subsection}{section}

\dieudonne_counter_within:nn{section}{chapter}

\dieudonne_counter_within:nn{equation}{chapter}
\dieudonne_counter_within:nn{equation}{section}
\dieudonne_counter_within:nn{equation}{subsection}
\dieudonne_counter_within:nn{equation}{subsubsection}
\dieudonne_counter_within:nn{equation}{paragraph}
\dieudonne_counter_within:nn{equation}{node}

%% To support "Chapter 0" or "Section 0": in these case we really want to print the 0's,
%% as opposed to the case where there _is_ no first section/chapter/etc.
\NewDocumentCommand\CounterZeroNext{m}{
  \setcounter{#1}{-1}
  \setcounter{dieudonne_#1_zero}{1}
}

\newcounter{dieudonne_chapter_zero}[dieudonne_chapter_zero]
\newcounter{dieudonne_section_zero}[dieudonne_section_zero]
\newcounter{dieudonne_subsection_zero}[dieudonne_subsection_zero]
\newcounter{dieudonne_subsubsection_zero}[dieudonne_subsubsection_zero]
\newcounter{dieudonne_paragraph_zero}[dieudonne_paragraph_zero]
\newcounter{dieudonne_node_zero}[dieudonne_node_zero]
\newcounter{dieudonne_equation_zero}[dieudonne_equation_zero]
 
\setcounter{tocdepth}{30}
\setcounter{secnumdepth}{30}




\cs_new:Npn \dieudonne_fmt_num:nn #1 #2 {
  \if_int_compare:w \value{#2}=0 
     \if_int_compare:w \value{dieudonne_#2_zero}=1
       #1{0}
     \fi
  \else 
    #1\arabic{#2}
  \fi
}

% Formatting for numbers that will appear in the table of contents
\cs_new:Npn \dieudonne_fmt_num_toc:n #1 {
  \dieudonne_fmt_num:nn {.} {#1}
}

% Formatting for numbers that will not appear in the table of contents
\cs_new:Npn \dieudonne_fmt_num_notoc:n #1 {
  \DieudonneFormatTrail{\dieudonne_fmt_num:nn {\DieudonneInterpunct} {#1}}
}


\DeclareExpandableDocumentCommand\thesection{}{%
  \arabic{section}%
}

\DeclareExpandableDocumentCommand\thesubsection{}{
  \thesection
  \dieudonne_fmt_num_toc:n {subsection}
}

\DeclareExpandableDocumentCommand\thesubsubsection{}{
  \thesubsection
  \dieudonne_fmt_num_toc:n {subsubsection}
}%

\DeclareExpandableDocumentCommand\theparagraph{}{
  \thesubsubsection
  \dieudonne_fmt_num_toc:n {paragraph}
}

\DeclareExpandableDocumentCommand\thesubparagraph{}{
  \theparagraph
  \dieudonne_fmt_num_toc:n {paragraph}
}


\DeclareExpandableDocumentCommand\thenode{}{
  \thesubparagraph
  \dieudonne_fmt_num_notoc:n {node}
}

\DeclareExpandableDocumentCommand\theequation{}{
  \thenode
  \dieudonne_fmt_num_notoc:n {equation}
}


\NewDocumentEnvironment{node}{}{
  \par\addvspace{.5\baselineskip}
  \refstepcounter{node}
  \noindent
  \hspace{\DieudonneNodeIndent}\textbf{(\thenode)}\hspace{.3em}
}{
  \par\addvspace{.5\baselineskip}
}


\ExplSyntaxOff

